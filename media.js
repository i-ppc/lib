var viewer,regex=[{name:/答案/,class:"ans",disabled:!1,icon:""},{name:/教學重點/,class:"teachPt",disabled:!1,icon:"xe900"},{name:/教學指引/,class:"teachIns",disabled:!1,icon:"xe901"},{name:/活動目的/,class:"actObj",disabled:!1,icon:"xe902"},{name:/史事速遞/,class:"histExp",disabled:!1,icon:"xe903"},{name:/人物介紹/,class:"charIntro",disabled:!1,icon:"xe904"},{name:/地理探知/,class:"geoExp",disabled:!1,icon:"xe905"},{name:/概念詳釋/,class:"detaExp",disabled:!1,icon:"xe906"},{name:/故事講述/,class:"story",disabled:!1,icon:"xe907"},{name:/文化知識庫/,class:"culKlgBase",disabled:!1,icon:"xe908"},{name:/歷史短評/,class:"shortHist",disabled:!1,icon:"xe909"},{name:/提問/,class:"qs",disabled:!1,icon:"xe90a"},{name:/圖意說明/,class:"picExp",disabled:!1,icon:"xe90b"},{name:/圖片補充/,class:"picLibrary",disabled:!1,icon:"xe90c"},{name:/詩文賞析/,class:"orgPoetry",disabled:!1,icon:"xe90d"},{name:/問答/,class:"showHideAns",disabled:!1,icon:"xe90e"},{name:/翻轉教室/,class:"pptFile",disabled:!1,icon:"xe90f"},{name:/電子地圖/,class:"WebSite",disabled:!1,link:!0,icon:"xe910"},{name:/歷史動畫/,class:"histAni",disabled:!1,icon:"xe911"},{name:/歷史影片/,class:"histVideo",disabled:!1,icon:"xe912"},{name:/圖片庫/,class:"picLibrary",disabled:!1,icon:"xe913"},{name:/地圖庫/,class:"mapLibrary",disabled:!0,icon:"xe914"},{name:/內容詳釋/,class:"explanation",disabled:!1,icon:"xe915"},{name:/圖說歷史/,class:"picStory",disabled:!1,link:!0,icon:"xe916"}],icons={pptFile:"play-circle",WebSite:"map-marked-alt",wordFile:"play-circle",histVideo:"play-circle",picLibrary:"file-image",mapLibrary:"file-image"},mediaBoxData={pptFile:[],WebSite:[],wordFile:[],histVideo:[],picLibrary:[],mapLibrary:[]},drawOption={shape:"path","default-shape":"path",path:{fill:"#1abc9c","fill-opacity":100,stroke:"#1abc9c","stroke-width":1,shape:"path"},hightLight:{fill:"#1abc9c","fill-opacity":50,stroke:"#1abc9c","stroke-width":10,shape:"hightLight"},ellipse:{fill:"#1abc9c","fill-opacity":50,stroke:"#1abc9c","stroke-width":1,shape:"ellipse"},rect:{fill:"#1abc9c","fill-opacity":50,stroke:"#1abc9c","stroke-width":1,shape:"rect"},line:{fill:"#1abc9c","fill-opacity":100,stroke:"#1abc9c","stroke-width":3,shape:"line"}},resetZoom=!0,isIOS=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.appVersion),myUp=isIOS?"touchend":"click";function inRange(e,t,a){return(e-t)*(e-a)<=0}function getChapter(e){switch(e){case"一":return 1;case"二":return 2;case"三":return 3;case"四":return 4;case"五":return 5;case"六":return 6;case"七":return 7;case"八":return 8;case"九":return 9;case"第一章":return 1;case"第二章":return 2;case"第三章":return 3;case"第四章":return 4;case"第五章":return 5;case"第六章":return 6;case"第七章":return 7;case"第八章":return 8;case"第九章":return 9;case"第8章":return 10;case"第9章":return 11;case"第10章":return 12;case"第11章":return 13;case"第12章":return 14;case"第13章":return 15;case"第14章":return 16;case"第15章":return 17;case"Chapter 8":return 10;case"Chapter 9":return 11;case"Chapter 10":return 12;case"Chapter 11":return 13;case"Chapter 12":return 14;case"Chapter 13":return 15;case"Chapter 14":return 16;case"Chapter 15":return 17}}function getBkPage(e,t){t||(t=ppcEbook.getCurlang());return e<pageContent["index_"+t].length+1?pageContent["index_"+t][e-1]:e-pageContent["index_"+t].length}function getIdName(e){var t;return $.each(pageContent.bookPageId,function(a,o){$.each(o,function(o,i){var n=i[0]+pageContent["index_"+ppcEbook.getCurlang()].length,s=i[1]+pageContent["index_"+ppcEbook.getCurlang()].length;inRange(e,n,s)&&(t="tp"+a+"ch"+o)})}),t}function getPgContent(e){var t;return $.each(pageContent.bookPage[ppcEbook.getCurlang()],function(a,o){0,$.each(o,function(o,i){var n=i[0]+pageContent["index_"+ppcEbook.getCurlang()].length,s=i[1]+pageContent["index_"+ppcEbook.getCurlang()].length;inRange(e,n,s)&&(t={order:getChapter(a),chapter:a,section:o,bkpg:getBkPage(e),page:e})})}),t}function getClassFromType(e){for(var t=0;t<regex.length;t++)if(regex[t].name.test(e))return regex[t];return""}$(document).ready(function(){function e(e){return e.stopPropagation?e.stopPropagation():window.event&&(window.event.cancelBubble=!0),e.preventDefault(),!1}document.addEventListener("keydown",function(t){t.ctrlKey&&t.shiftKey&&73==t.keyCode&&e(t),t.ctrlKey&&t.shiftKey&&74==t.keyCode&&e(t),83==t.keyCode&&(navigator.platform.match("Mac")?t.metaKey:t.ctrlKey)&&e(t),t.ctrlKey&&85==t.keyCode&&e(t),event.keyCode},!1),ppcEbook.init(0),viewer=ppcEbook.getViewer(),ppcEbook.updatePg();var t,a=!1;$("#mediaLibrary").on("click",function(){$("#v-pills-pptFile-tab").click(),$("#myModal").attr("title","媒體資料庫"),$("#myModalLabel").html("媒體資料庫")});var o="pptFileP";function i(e,t,a,i){a?($("#"+o+" tr").hide(),$("#"+o+" tr["+e+"='"+t+"']["+a+"='"+i+"']").show(),$('#sel-submenu li[aria-label="'+t+'"]').show(),$('#sel-submenu li[aria-label!="'+t+'"]').hide()):($("#"+o+" tr["+e+"!='"+t+"']").hide(),$("#"+o+" tr["+e+"='"+t+"']").show(),$('#sel-submenu li[aria-label="'+t+'"]').show(),$('#sel-submenu li[aria-label!="'+t+'"]').hide())}$("body").on("click","#ch-submenu a.nav-link",function(e){var a=$(this).attr("data-ch");t=a,0!=a?(i("data-ch",a),$("#ch-submenu li").removeClass("active"),$(this).parent().addClass("active")):$("#v-pills-tabContent tr").show()}),$("body").on("click","#sel-submenu a.nav-link",function(e){var a=$(this).attr("data-sel");0!=a?(i("data-ch",t,"data-sel",a),$("#sel-submenu li").removeClass("active"),$(this).parent().addClass("active")):$("#v-pills-tabContent tr").show()}),$("#myModal a.nav-link").on("click",function(e){var i;i=0,$("#ch-submenu").html(""),$("#sel-submenu").html(""),$.each(pageContent.bookPage[ppcEbook.getCurlang()],function(e,a){var o=e,n=getChapter(e),s=$("<li/>",{class:"dropdown-item dropdown-submenu",id:"subMenu"+i,html:'<a  class="w-100 nav-link"   data-ch="'+n+'" style="display: inline-block;">'+o+"</a>"}).appendTo("#ch-submenu");0==i&&(t=n,$(s).addClass("active")),$.each(a,function(t,a){var o,n;o="&nbsp;&nbsp;&nbsp;&nbsp;"+t,n=pageContent.bookPage[ppcEbook.getCurlang()][e][t][2];var s=$("<li/>",{class:"dropdown-item dropdown-submenu",id:"subMenu"+i,"aria-label":getChapter(e),html:'<a  class="w-100 nav-link"   data-sel="'+n+'" style="display: inline-block;">'+o+"</a>"});"0"!=t&&$(s).appendTo("#sel-submenu"),i>0&&$(s).hide()}),i++}),$("#myModal a.active").removeClass("active");var n,s=$(this).html();$("#dropdownMenuLink").html(s),o=$(this).attr("aria-controls"),n="",n=JSON.parse(JSON.stringify(mediaBoxData)),ppcEbook.getCurlang(),a||($.each(n,function(e,t){if("picLibrary"!=e){var a=".mlayer ."+e+"[data-lang='"+ppcEbook.getCurlang()+"']";$.each($(a),function(t,a){var o=$(this).attr("id"),i=$(this).attr("data-content-idx"),s=$(this).attr("data-lang");if(o){var r=getPgContent(parseInt($(this).closest(".pf").attr("data-page-no")));r&&(r.type=e,r.idx=i,r.target="#"+o,r.targetContent="#"+o+"Content",r.dataContent=$(r.target).attr("data-content-idx"),r.lang=s,popData[i]?"object"==typeof popData[i][1]&&(popData[i][1].group?r.desc=popData[i][1].group:r.desc=popData[i][1].desc,""!=popData[i][1].src&&(r.src=popData[i][1].src),Object.keys(popData[i][1]).length>2&&(r.doc_src=popData[i][1].doc_src)):($(a).attr("href")?r.src=$(a).attr("href"):r.src=$(a).attr("data-src"),r.desc=$(a).attr("title")),n[e].push(r))}})}else{JSON.parse(JSON.stringify(imgLab));for(var o=Object.keys(imgLab),i=0;i<o.length;i++){var s=imgLab[o[i]],r={};$.each(s,function(e,t){r.chapter=s[0],r.section=s[1],r.bkpg=s[2],r.page=s[2]+pageContent.index.length,r.order=getChapter(s[0]),"object"==typeof t&&(r.target=o[i],r.desc=o[i],r.src="img-popover",t.hasOwnProperty("thumb")&&(r.thumb=t.thumb))}),n[e].push(r)}}}),$.each(n,function(e,t){var a="",o="#"+e+"P";content="",$(o).html(content),a+=' <table class="table table-striped mb-0">',$.each(t,function(t,o){var i=getIdName(o.page);a=a+'<tr class="row" data-ch="'+o.order+'" data-sel="'+i+'" data-page="'+o.page+'" ><td class="col text-center"><div class="text-center  px-0 py-2">'+o.chapter+'</div></td><td class="col-5 text-center"><div class="text-center  px-0 py-2">'+o.desc+"</div></td>",o.src?a=o.src.indexOf("http")>-1&&"WebSite"!=o.type?a+'<td class="col text-center"><div class="text-center  px-0 py-2 cursor-pointer" ><span class=\'cursor-pointer  text-dark\'><a class="video-popover" href="#" data-content-idx="'+o.dataContent+'" data-toggle="modal" data-src="'+o.src+'"><i class="fa  fa-'+icons[e]+'"></i></a></span></div></td>':"img-popover"==o.src?a+'<td class="col text-center"><div class="text-center  px-0 py-2 img-popover" data-MediaContent-Idx="'+o.target+'" data-toggle="modal" ><span class=\'cursor-pointer  text-dark\'><i class="fa  fa-'+icons[e]+'"></i></span></div></td>':"mapLibrary"==o.type?a+'<td class="col text-center"><div class="text-center  px-0 py-2 img-popover" data-content-idx="'+o.idx+'" data-toggle="modal" ><span class=\'cursor-pointer  text-dark\'><i class="fa  fa-'+icons[e]+'"></i></span></div></td>':"WebSite"==o.type?a+'<td class="col text-center"><div class="text-center  px-0 py-2 cursor-pointer btn " data-content-idx="'+o.idx+"\" data-toggle=\"modal\" ><a class='cursor-pointer  text-dark' href='"+o.src+"' target='_blank'><i class=\"fa  fa-"+icons[e]+'"></i></a></div></td>':"wordFile"==o.type?a+'<td class="col text-center"><div class="text-center  px-0 py-2 cursor-pointer btn" onclick=\'window.open("'+o.src+'", "_blank");\'><span class=\'cursor-pointer  text-dark\'><i class="fa fa-file-alt"></i></span></div></td>':"pptFile"==o.type?a+'<td class="col text-center"><div class="text-center  px-0 py-2 cursor-pointer btn" onclick=\'window.open("'+o.src+'", "_blank");\'><span class=\'cursor-pointer  text-dark\'><i class="fa fa-file-alt"></i></span></div></td>':a+'<td class="col text-center"><div class="text-center  px-0 py-2 cursor-pointer btn" onclick="$(\''+o.target+"').trigger('click')\"><span class='cursor-pointer  text-dark'><i class=\"fa  fa-"+icons[e]+'"></i></span></div></td>':a+='<td class="col text-center"><div class="text-center  px-0 py-2" > - </div></td>',a=a+'<td class="col text-center"><div class="text-center  px-0 py-2 jump" onclick="$(\'#myModal\').modal(\'hide\');ppcEbook.jump('+o.page+')">P.'+o.bkpg+"</div></td></tr>"}),a+="</table>",$(o).html(a)}),a=!1),$("#"+o+" tr").show()}),window.addEventListener("message",function(e){e.data,e.data&&($(".currentPop iframe").css("height",e.data+"px"),s(".currentPop"))}),$('a[data-toggle="pill"]').on("show.bs.tab",function(e){var t=$(this).attr("aria-controls").replace("P","");"flipClass"==t||"histAni"==t||"histVideo"==t?($(".ws").show(),$(".ws_title").html("工作紙")):($(".ws").hide(),$(".ws_title").html(" "))});var n=!0;$("#toggle-disabled").on("click",function(e){e.preventDefault(),n?($(this).attr("value","Enable Menu"),ppcEbook.deleteMenu(),n=!1):($(this).attr("value","Disable Menu"),ppcEbook.createMenu(),n=!0)});function s(e){var t,a=0,o="#"+$(e).attr("data-parent");$(o)&&$(o)[0]&&($(o)[0].getBoundingClientRect().left+"px",$(o)[0].getBoundingClientRect().top+"px",t=parseFloat($(o).css("left").replace("px","")),(a=parseFloat($(o).css("bottom").replace("px","")))||(a=0),t||(t=0));$(o).attr("data-custom-class")&&$(o).attr("data-custom-class");var i=1,n=$(e).width(),s=$(o).attr("data-placement"),r=$(o).attr("data-loc");if(r)"string"==typeof(r=r.split(","))[0]&&(r[0]=parseFloat(r[0].replace("px",""))),"string"==typeof r[1]&&(r[1]=parseFloat(r[1].replace("px",""))),t=r[0],a=r[1];else if(s)switch(s){case"top":a=a+$(o).height()+10;break;case"left":var c;(c=$(e).css("max-width")).indexOf("%")>=0&&(c=parseInt(c.replace("%","")),c=parseFloat($(".pf").width())*c/100),c>n&&(n=c),t-=n,a=a-$(e).height()+$(o).height();break;default:$(e).css("max-width")>n&&(i=n/$(e).css("max-width")),a-=$(e).height()*i}else(c=$(e).css("max-width"))&&(c.indexOf("%"),$(e).css("max-width")>n&&(i=n/$(e).css("max-width"))),a=a-$(e).height()*i-$(o).height()-10;var l,p=$(".mlayer").width(),d=($(".mlayer").height(),$(e).width());$(e).height();(l="string"==typeof t?parseFloat(t.replace("px",""))+d:t+d)>p&&(t-=l-p);a<0&&(a=0),t+="px",a+="px",$(e).css("bottom",a),$(e).css("left",t)}$("body").on("click touchstart",".popover .close",function(e){$(this).parent().hide(),$(this).parent().css("transform",""),$(".audioPlayer .popover .popover-body").html(""),$(".currentPop").removeClass("currentPop")}),$("body").on(myUp,".info-popover",function(e){e.preventDefault();var t=$(this).attr("data-target"),a="",o="",i="";$(".currentPop").removeClass("currentPop"),"audio-player"==t?(a="#"+$(this).parent().attr("id")+"Content",o=$(this).parent().attr("id")+"Content"):(a="#"+$(this).attr("id")+"Content",o=$(this).attr("id")+"Content",i=$(this).attr("id"));var n,r,c,l,p=$(this).attr("data-content-idx"),d="",h="text";(n=popData[p])&&("object"==typeof n[0]?(c=(r=getClassFromType(n[0].title)).class,l=n[0].title,h=n[0].loadMethod):(c=(r=getClassFromType(n[0])).class,l=n[0]));var u=[];if("histVideo"==c)u[0]="<p class='font-weight-bold'>"+n[1].desc+"</p>",u[1]="<a class='video-popover' href='#' data-content-idx='"+p+"' data-toggle='modal' data-src='"+n[1].src+"' >"+n[1].src+"</a>",d=u.slice(0,u.length).join("");else if("audio-player"==t){var v=$(this).attr("href"),b=v.split("/");l=b[b.length-1],u[0]="<p class='font-weight-bold'></p>",u[1]="<div id='player'> <audio class='audioPlayer' controls autoplay><source src='"+v+"'' type='audio/mpeg'> Your browser does not support the audio element. </audio> </div>",d=u.slice(0,u.length).join("")}else if("qs"==c)$.each(n,function(e,t){1==e?u[e]="<p>"+t+"<div class='mediaButton showHideAns' style='margin-left:-5px;' data-target='#qa"+p+"' data-type='showHideAns' data-func='showHide' id='qs"+p+"' ></div></p>":2==e&&(u[e]="<p style='visibility: hidden;' id='qa"+p+"'>"+t+"</p>")}),d=u.slice(1,u.length).join("");else if("teachPt"==c||"actObj"==c)$(n).length>2?($.each(n,function(e,t){u[e]="<li>"+t+"</li>"}),d="<ol>"+u.slice(1,u.length).join("")+"</ol>"):($.each(n,function(e,t){u[e]="<p>"+t+"</p>"}),d=u.slice(1,u.length).join(""));else if("iframe"==h){d="<iframe  id='"+p+"_frame'  class= 'w-100' type='content-primary' frameborder= '0' scrolling=no'  src= 'content/"+n[1]+"'/></iframe>"}else $.each(n,function(e,t){u[e]="<p>"+t+"</p>"}),d=u.slice(1,u.length).join("");if($(a).length>=1&&"audio-player"!=t)"none"==$(a).css("display")?($(a).show(),$(a).addClass("currentPop")):($(a).hide(),$(a).css("transform",""));else if("audio-player"==t)"none"==$(".audioPlayer .popover").css("display")&&($(".audioPlayer .popover").show(),$(".audioPlayer .popover").css("transform","")),$(".audioPlayer .popover .popover-header .title").text(l),$(".audioPlayer .popover .popover-body").html(d),f=$(".audioPlayer .popover");else{$(this)[0].getBoundingClientRect().left,$(this)[0].getBoundingClientRect().top,parseFloat($(this).css("left").replace("px","")),parseFloat($(this).css("bottom").replace("px",""));var g="";$(this).attr("data-custom-class")&&(g=$(this).attr("data-custom-class"));var f="";r&&"audio-player"!=t&&(f=$("<div class='popover "+c+" "+g+"' id='"+o+"' data-parent='"+i+"' style='position:absolute; top:auto;bottom:0; left:0;'><div class='popover-header draggableHeader bg-info'><span class='ppcIcon-t text-white fa fa-"+r.icon+" fa-flip-vertical'></span><span class='text-white' style='padding-left:2px;padding-top: 1px;position: absolute;' > "+l+"</span></div><button type='button' style='position:absolute;right:5px;top:0px;'  class='close text-white'  aria-label='Close'> <span aria-hidden='true'>&times;</span> </button><div class='popover-content'></div> <div class='popover-body'>"+d+"</div> </div>")),"emap"!=c&&"audio-player"!=t&&"picStory"!=c&&$(f).appendTo($(this).parent()),s($(f)),$(f).addClass("currentPop")}}),$("body").on("click",".draw-pen-popover",function(e){$(".activeP").removeClass("activeP"),$(".draw-pen-popover").addClass("activeP");var t="#"+$(this).attr("id")+"Content";$(this).attr("class");if($(".drawTools").length>=1)"none"==$(".drawTools").css("display")?$(".drawTools").show():$(".drawTools").hide();else{$(this)[0].getBoundingClientRect().left,$(this)[0].getBoundingClientRect().top,$(this).css("left"),$(this).css("bottom");var a=$("<div class='drawTools popover fade bs-popover-bottom show dawBar searchBox w-45 mfx-450' style='z-index:99;left:auto;right:5px;'><div class='popover-body'>"+$(t).html()+"</div> </div>");$(a).appendTo($("body")),$(a).css("top","52px"),ppcEbook.enableDraw(),$(".draw-"+drawOption.shape).addClass("active"),$(".popover .stroke-width").TouchSpin({min:1,max:20,step:1,decimals:0,boostat:5,maxboostedstep:20,postfix:""}),$(".popover .stroke-alpha").TouchSpin({min:10,max:100,step:10,decimals:0,boostat:5,maxboostedstep:20,postfix:""}),!0,$(".popover .stroke-width").val(drawOption[drawOption.shape]["stroke-width"]),$(".popover .stroke-alpha").val(drawOption[drawOption.shape]["fill-opacity"]),$(".color-popover").popover({html:!0,trigger:"click touchstart",sanitize:!1,placement:"auto",delay:30,content:function(){return $(".color-picker-tmp").html()},boundary:"viewport"})}});var r=["#1abc9c","#2ecc71","#3498db","#9b59b6","#34495e","#f1c40f","#e67e22","#e74c3c","#ecf0f1","#95a5a6"];new Piklor(".color-picker-tmp",r,{});$(".color-popover").css("background",r[0]),drawOption[drawOption.shape].fill=r[0],$("body").on("click",".popover.color-picker",function(e){var t=e.target.getAttribute("data-col");t&&($(".color-popover").css("background",t),$(this).popover("hide"),drawOption[drawOption.shape].fill=t)});var c;function l(){$(".popover .stroke-width").val(drawOption[drawOption.shape]["stroke-width"]),$(".popover .stroke-alpha").val(drawOption[drawOption.shape]["fill-opacity"]),$(".color-popover").css("background",drawOption[drawOption.shape].fill)}$(".draw-pen-popover").on("shown.bs.popover",function(){$(".activeP").removeClass("activeP"),$(".draw-pen-popover").addClass("activeP"),ppcEbook.enableDraw(),$(".draw-"+drawOption.shape).addClass("active"),l(),$(".popover .stroke-width").TouchSpin({min:1,max:20,step:1,decimals:0,boostat:5,maxboostedstep:20,postfix:""}),!0,$(".popover .stroke-width").val(drawOption[drawOption.shape]["stroke-width"]),$(".color-popover").popover({html:!0,trigger:"click touchstart",sanitize:!1,placement:"auto",delay:30,content:function(){return $(".color-picker-tmp").html()},boundary:"viewport"})}),$("body").on("click touchstart",".normal",function(e){ppcEbook.disableDraw(),$(".activeP").removeClass("activeP"),$(this).addClass("activeP")}),$("#content-popover").on("shown.bs.dropdown",function(){ppcEbook.disableDraw(),$(".activeP").removeClass("activeP"),$(".normal").addClass("activeP")}),$("body").on("click touchstart",".draw-line",function(){drawOption.shape="line",ppcEbook.enableDraw(),$(".active").removeClass("active"),$(this).addClass("active"),l()}),$("body").on("click touchstart",".draw-path",function(){drawOption.shape="path",ppcEbook.enableDraw(),$(".active").removeClass("active"),$(this).addClass("active"),l()}),$("body").on("click touchstart",".draw-hightLight",function(){drawOption.shape="hightLight",ppcEbook.enableDraw(),$(".active").removeClass("active"),$(this).addClass("active"),l()}),$("body").on("click touchstart",".draw-rect",function(){console.log("rect"),drawOption.shape="rect",ppcEbook.enableDraw(),$(".active").removeClass("active"),$(this).addClass("active"),l()}),$("body").on("touchstart click",".draw-ellipse",function(){console.log("ellipse"),drawOption.shape="ellipse",ppcEbook.enableDraw(),$(".active").removeClass("active"),$(this).addClass("active"),l()}),$("body").on("change",".stroke-width",function(){drawOption[drawOption.shape]["stroke-width"]=$(this).val()}),$("body").on("change",".stroke-alpha",function(){drawOption[drawOption.shape]["fill-opacity"]=$(this).val()}),$("body").on("touchend click",".img-popover",function(e){var t,a=$(this).attr("data-content-idx"),o=$(this).attr("data-mediaContent-Idx");if(t=a?popData[a]:imgLab[o],$(".carousel-inner").html(""),t){if(t.length>0){"object"==typeof t[0]?(obj=getClassFromType(t[0].title),t[0].title):(obj=getClassFromType(t[0]),t[0]);var i=0,n=0;$.each(t,function(e,t){if(0!=e&&"object"==typeof t){if(n++,1==++i)var a=$("<div/>",{class:"carousel-item active w-100"});else a=$("<div/>",{class:"carousel-item w-100"});var o=t.src;t.hasOwnProperty("thumb")&&(o=t.thumb);var s=$("<img/>",{class:"img-responsive cursor-zoom-in",src:o,alt:t.desc,click:function(){$("#fullimage").attr("src",t.src),$("#hidden_link").attr("href",t.src),$("#hidden_link").fancybox().trigger("click")}}),r=($("<a/>",{class:"btn",style:"z-index:100",href:t.src,html:"<i class='fa fa-download'></i>",target:"_blank",download:"download.png"}),$("<div/>",{class:"d-block py-3 mx-auto",style:"width:max-content;",html:"<span>"+t.desc+"</span>"}));if($(r).appendTo($(a)),$(s).appendTo($(a)),t.caption){"-"==t.caption&&(t.caption="");var c=$("<div/>",{class:"",html:'<h6 class="mt-2">'+t.caption+"</h6>"});$(c).appendTo($(a))}$(a).appendTo(".carousel-inner")}}),n<2?($(".carousel-control-prev").hide(),$(".carousel-control-next").hide()):($(".carousel-control-prev").show(),$(".carousel-control-next").show())}}$("#imgModal").modal("show"),e.preventDefault()}),$("body").on("touchend click",".video-popover",function(e){c=$(this).data("src"),$href=$(this).attr("href");var t=$(this).attr("data-content-idx");if(t){var a=popData[t];a&&a.length>0&&(c="object"==typeof a[1]?a[1].src:a[1],$("#videoModal .modal-title").html('<span class="text-white font-weight-bold">'+a[1].desc+"</span>"))}else c=$(this).attr("data-src");"#"==$href&&$("#videoModal").modal("show")}),$("#videoModal").on("shown.bs.modal",function(e){$("#video").removeClass("visible"),$("#video").removeClass("invisible"),$("#videoiframe").removeClass("visible"),$("#videoiframe").removeClass("invisible"),c.match(/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/)&&RegExp.$1?($("#video").addClass("invisible"),$("#videoiframe").addClass("visible"),$("#videoiframe").attr("src",c+"?autoplay=1&amp;modestbranding=1&amp;showinfo=0"),$("#videoiframe").attr("preload","metadata")):($("#videoiframe").addClass("invisible"),$("#video").addClass("visible"),$("#video").attr("src",c))}),$("#videoModal").on("hide.bs.modal",function(e){$("#videoiframe").attr("src",""),$("#video").attr("src","")});var p,d="",h=["rgba(255, 0, 0, 0.4)"],u=function(){if(d=$(".popover-body #txtFinder").val(),p&&p.revert(),d){searchData.content!=d&&(searchData.content=d,searchData.time=-1);try{var e=RegExp(d,"gi")}catch(e){return}try{p=findAndReplaceDOMText(container,{find:e,replace:function(e,t){!0;var a=document.createElement("em");return a.style.backgroundColor=h[t.index%h.length],a.innerHTML="<a name=result"+t.index+">"+e.text+"</a>",a.classList.add("searchR"),a},forceContext:findAndReplaceDOMText.NON_INLINE_PROSE}),ppcEbook.goTo("#result"+searchData.time)}catch(e){throw e}}};$("body").on("click","#searchBtn",function(e){searchData.time<$(".searchR").length-1?searchData.time++:searchData.time=0,u()}),$(".search-popover").popover({html:!0,trigger:"click",sanitize:!1,placement:"bottom",delay:30,template:"<div class='popover searchBox mw-50'><div class='popover-content'></div> <div class='popover-body'></div> </div>",content:function(){var e="#"+$(this).attr("id")+"Content";$(this).attr("class");return $(e).html()},boundary:".pc"+ppcEbook.getCurPgIdx(),fallbackPlacement:["left","right","top","bottom"]}),$(".search-popover").on("hidden.bs.popover",function(){u(),searchData.time=-1}),$("#pgBox").on("touchend click",function(e){var t=$("#pgInputBox").val();t.match(/^[a-zA-Z]+$/)?$("#pgInputBox").val(""):t>0&&t<=$(".pf").length-pageContent["index_"+ppcEbook.getCurlang()].length&&(ppcEbook.jump(parseInt(t)-1+pageContent["index_"+ppcEbook.getCurlang()].length),ppcEbook.viewer.cur_page_idx=parseInt(t)-1+pageContent["index_"+ppcEbook.getCurlang()].length,ppcEbook.updatePg(),$("#pgInputBox").val("")),ppcEbook.updateThumb(),e.preventDefault()}),$("#pgInputBox").on("keydown",function(e){if(13===e.keyCode){e.preventDefault();var t=$("#pgInputBox").val();t.match(/^[a-zA-Z]+$/)?$("#pgInputBox").val(""):t>0&&t<=$(".pf").length-pageContent["index_"+ppcEbook.getCurlang()].length&&(ppcEbook.jump(parseInt(t)-1+pageContent["index_"+ppcEbook.getCurlang()].length),ppcEbook.viewer.cur_page_idx=parseInt(t)-1+pageContent["index_"+ppcEbook.getCurlang()].length,ppcEbook.updatePg(),$("#pgInputBox").val(""))}ppcEbook.updateThumb()}),$("body").on("touchend click",".jump",function(e){var t=parseInt($(this).attr("data-target"));ppcEbook.jump(t),e.preventDefault()}),$("#sidebarContent a").on("touchend click",function(e){touchmoved||ppcEbook.disableBookMark()}).on("touchmove",function(e){touchmoved=!0}).on("touchstart",function(){touchmoved=!1}),$(".outline a").on("touchend",function(e){touchmoved||ppcEbook.bkmJump(e)}).on("touchmove",function(e){touchmoved=!0}).on("touchstart",function(){touchmoved=!1}),$(".sound a").on("touchend click",function(e){ppcEbook.disableBookMark()}),$(".onoffeye a").on("touchend",function(e){event.preventDefault(),onoffMouseDown(e,1)}),$("body").on("click",".jcode2 a, .jcode3 a, .jts a, .jms a, .jdf a",function(e){e.preventDefault();var t=$(this).attr("data-elementtobejumpedid");t&&ppcEbook.goHref(t)}),$("#backward").on("click",function(e){0==ppcEbook.getviewHisCounter()?($(this).addClass("disabled"),$(this).attr("disabled",!0)):($(this).removeClass("disabled"),$(this).attr("disabled",!1)),ppcEbook.goBackward()}),$("#forward").on("click",function(e){ppcEbook.goForward()}),$("body").on("change","#loadSave",function(e){$(this).parent().parent().removeClass("show");e.currentTarget.files[0];!function(e){var t=e.target.files[0];if(t){var a=new FileReader;a.onload=function(e){var t=e.target.result;v(t)},a.readAsText(t)}else alert("Failed to load file")}(e),$(this).html("")});var v=function(e){var t=$("<script/>");$(t).html(e),$("body").append(t),doublePage=transScriptList.doublePage,ppcEbook.viewer._updateSpreadMode(!1),ppcEbook.viewer.navigate_to_dest(transScriptList.view),$(".ans, .line3, .onoffcodeul").each(function(e){$(this).css({visibility:"hidden"})}),$(".drawBoardReal").each(function(e){$(this).html("")}),"EE"==transScriptList.currentLang?setTimeout(function(){ppcEbook.setCurlang("EE")},1e3):setTimeout(function(){ppcEbook.setCurlang("CE")},1e3),setTimeout(function(){for(var e=0;e<transScriptList.ansData.length;e++)$("#"+transScriptList.ansData[e]).css({visibility:"visible"}),$("a[data-targetelementids='"+transScriptList.ansData[e]+"']").each(function(e){var t=$(this).parent().attr("id");onoffMouseDown(t,2)});$(".triggeronoffsp").each(function(e){var t=$(this).attr("id");triggeronoffMouseDown(t,2)}),$(".showonoffsp").each(function(e){var t=$(this).attr("id"),a=$(this).find("img").attr("src");a&&(a.includes("showonoff2")?showonoffMouseDown(t,2,2):showonoffMouseDown(t,2,1))})},1e3);for(var a=0;a<transScriptList.pgData.length;a++){var o=SVG.get(transScriptList.pgData[a].id);e=transScriptList.pgData[a].html.replace(/'/g,"");console.log(o),o.svg(e)}};$("body").on("click","#switchPg",function(e){doublePage?doublePage=!1:(doublePage=!0,resetZoom=!0),ppcEbook.viewer._updateSpreadMode()}),$("body").on("click","#save",function(e){var t=new Array,a=new Array,o=ppcEbook.getCurlang(),i={curpg:ppcEbook.viewer.cur_page_idx,currentLang:o,scale:ppcEbook.viewer.scale,view:ppcEbook.viewer.get_current_view_hash(),doublePage:doublePage};$(".drawBoardReal").each(function(e){if($(this)[0].hasChildNodes()&&$(this)[0].children.length>0){new XMLSerializer;var a={id:$(this).attr("id"),html:"'"+$(this).html()+"'"};t.push(a)}}),$(".ans, .note, .line3, .onoffcodeul").each(function(e){if("visible"==$(this).css("visibility")){var t=$(this).attr("id");a.push(t)}}),i.ansData=a,i.pgData=t,i.currentLang=ppcEbook.getCurlang(),function(e){var t="var transScriptList = "+JSON.stringify(e),a="text/json;charset=utf-8,"+encodeURIComponent(t),o=new Date,i=String(o.getDate()).padStart(2,"0"),n=String(o.getMonth()+1).padStart(2,"0"),s=o.getFullYear();o=n+i+s;var r=document.createElement("a");r.href="data:"+a,r.download="ppcEbook"+o+".json",r.innerHTML='<span class="CE">下載儲存</span><span class="EE">Download Save</span>',document.getElementById("saveDownload").appendChild(r)}(i)}),$("body").on("click","#removeAllMod #btn-left, #removeAllMod #btn-right",function(e){var t=$(this).attr("data-target");t&&(ppcEbook.cleanPg(t),$("#removeAllMod").modal("hide"))}),$("#thumb").parent().append($('<button class="btn btn-sm" type="button" id="switchPg" aria-haspopup="true" aria-expanded="false"> <i class="fa fa-single-page fa-2x d-block"></i> <i class="fa fa-double-page fa-2x d-none"></i> </button>  ')),$("body").append('<div class="modal" id="removeAllMod" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <p class="w-100 text-center"><span class=""CE">你希望清除那一頁?</span><span class="EE">Which page you want to clean?</span></p> </div> <div class="modal-body d-flex flex-row"> <button type="button" class="btn btn-primary w-50" style="height:250px;font-size:18pt;" id="btn-left"></button> <button type="button" class="btn btn-info w-50" style="height:250px;font-size:18pt;"" id="btn-right"></button> </div> </div> </div> </div>'),$("#draw-pen").parent().prepend($('<div class="dropdown" id="loadSaveGroup" title="載入變更"> <button class="btn btn-sm dropdown-toggle" type="button" id="loadsaveBtn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <i class="fa fa-folder-open fa-2x"></i> </button> <div class="dropdown-menu" style="min-width: 130px;" aria-labelledby="dropdownMenuButton"> <div class="btn dropdown-item default-fonts"> <input type="file" class="form-control-file" id="loadSave"></div> </div> </div> <div class="dropdown" id="SaveGroup" title="儲存變更"> <button class="btn btn-sm dropdown-toggle" id="save" type="button" id="content-popover-btn" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> <i class="fa fa-save fa-2x"></i> </button> <div class="dropdown-menu" style="min-width: 130px;" aria-labelledby="dropdownMenuButton"> <div class="btn dropdown-item default-fonts"> <div id="saveDownload"></div> </div> </div> </div>'))});